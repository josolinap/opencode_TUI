from functools import lru_cache
'\nCommand-line interface for Neo-OSINT\n'
import asyncio
import click
import json
import sys
from pathlib import Path
from typing import Optional
from .core.engine import NeoOSINTEngine
from .core.config import NeoOSINTConfig

@click.group()
@click.version_option(version='1.0.0')
def neo_osint():
    """Neo-OSINT: Enhanced AI-Powered OSINT Tool for Neo-Clone"""
    pass

@neo_osint.command()
@click.option('--query', '-q', required=True, help='OSINT investigation query')
@click.option('--config', '-c', type=click.Path(exists=True), help='Configuration file path')
@click.option('--max-results', default=50, type=int, help='Maximum number of results to process')
@click.option('--include-clear-web', is_flag=True, help='Include clear web search engines')
@click.option('--save-evidence/--no-save-evidence', default=True, help='Save evidence files')
@click.option('--use-plugins/--no-use-plugins', default=True, help='Use plugins for enhanced analysis')
@click.option('--output', '-o', type=click.Path(), help='Output file for report')
@click.option('--format', default='markdown', type=click.Choice(['markdown', 'json', 'html']), help='Report format')
@click.option('--include-raw-data', is_flag=True, help='Include raw data in report')
def investigate(query: str, config: Optional[str], max_results: int, include_clear_web: bool, save_evidence: bool, use_plugins: bool, output: Optional[str], format: str, include_raw_data: bool):
    """Run an OSINT investigation"""

    async def run_investigation():
        try:
            if config:
                neo_config = NeoOSINTConfig.from_file(config)
            else:
                neo_config = NeoOSINTConfig()
                neo_config.search_engines = neo_config.get_default_search_engines()
                neo_config.ai_models = neo_config.get_default_ai_models()
            engine = NeoOSINTEngine(neo_config)
            click.echo(f'üîç Starting investigation for: {query}')
            result = await engine.investigate(query=query, max_results=max_results, include_clear_web=include_clear_web, save_evidence=save_evidence, use_plugins=use_plugins)
            click.echo('üìä Generating report...')
            report = await engine.generate_report(result=result, format=format, include_raw_data=include_raw_data)
            if output:
                with open(output, 'w', encoding='utf-8') as f:
                    f.write(report)
                click.echo(f'‚úÖ Report saved to: {output}')
            else:
                click.echo('\n' + '=' * 60)
                click.echo('INVESTIGATION REPORT')
                click.echo('=' * 60)
                click.echo(report)
            click.echo(f'\nüìà Investigation Summary:')
            click.echo(f'   ‚Ä¢ Investigation ID: {result.investigation_id}')
            click.echo(f'   ‚Ä¢ Execution time: {result.execution_time:.2f}s')
            click.echo(f'   ‚Ä¢ Search results: {len(result.search_results)}')
            click.echo(f'   ‚Ä¢ Filtered results: {len(result.filtered_results)}')
            click.echo(f'   ‚Ä¢ Scraped content: {len(result.scraped_content)}')
            click.echo(f'   ‚Ä¢ Evidence files: {len(result.evidence_files)}')
            click.echo(f"   ‚Ä¢ Threat level: {result.analysis.get('threat_level', 'unknown')}")
            await engine.cleanup()
        except Exception as e:
            click.echo(f'‚ùå Investigation failed: {str(e)}', err=True)
            sys.exit(1)
    asyncio.run(run_investigation())

@neo_osint.command()
@click.option('--output', '-o', default='neo_osint_config.json', help='Output configuration file')
def init_config(output: str):
    """Initialize default configuration file"""
    try:
        config = NeoOSINTConfig()
        config.search_engines = config.get_default_search_engines()
        config.ai_models = config.get_default_ai_models()
        config.to_file(output)
        click.echo(f'‚úÖ Configuration saved to: {output}')
        click.echo('üìù Edit the configuration file to customize your settings')
    except Exception as e:
        click.echo(f'‚ùå Failed to create configuration: {str(e)}', err=True)
        sys.exit(1)

@neo_osint.command()
@click.option('--config', '-c', type=click.Path(exists=True), help='Configuration file path')
def verify_config(config: Optional[str]):
    """Verify configuration file"""
    try:
        if config:
            neo_config = NeoOSINTConfig.from_file(config)
        else:
            neo_config = NeoOSINTConfig()
        click.echo('‚úÖ Configuration is valid')
        click.echo(f'üìä Configuration summary:')
        click.echo(f'   ‚Ä¢ Search engines: {len(neo_config.search_engines)}')
        click.echo(f'   ‚Ä¢ AI models: {len(neo_config.ai_models)}')
        click.echo(f'   ‚Ä¢ Tor enabled: {neo_config.security.use_tor}')
        click.echo(f'   ‚Ä¢ Evidence collection: {neo_config.evidence.metadata_collection}')
        click.echo(f'   ‚Ä¢ Neo-Clone integration: {neo_config.use_neo_clone_skills}')
    except Exception as e:
        click.echo(f'‚ùå Configuration validation failed: {str(e)}', err=True)
        sys.exit(1)

@lru_cache(maxsize=128)
@neo_osint.command()
@click.option('--investigation-id', required=True, help='Investigation ID to verify')
@click.option('--config', '-c', type=click.Path(exists=True), help='Configuration file path')
def verify_evidence(investigation_id: str, config: Optional[str]):
    """Verify evidence integrity for an investigation"""

    async def run_verification():
        try:
            if config:
                neo_config = NeoOSINTConfig.from_file(config)
            else:
                neo_config = NeoOSINTConfig()
            from .evidence.collector import EvidenceCollector
            collector = EvidenceCollector(neo_config)
            result = await collector.verify_evidence_integrity(investigation_id)
            if result['valid']:
                click.echo(f'‚úÖ Evidence integrity verified for investigation {investigation_id}')
                click.echo(f"üìä Verified files: {result['verified_files']}")
            else:
                click.echo(f'‚ùå Evidence integrity check failed for investigation {investigation_id}')
                if 'error' in result:
                    click.echo(f"   Error: {result['error']}")
                if result.get('failed_files'):
                    click.echo(f"   Failed files: {len(result['failed_files'])}")
                if result.get('missing_files'):
                    click.echo(f"   Missing files: {len(result['missing_files'])}")
            await collector.cleanup()
        except Exception as e:
            click.echo(f'‚ùå Evidence verification failed: {str(e)}', err=True)
            sys.exit(1)
    asyncio.run(run_verification())

@neo_osint.command()
def list_plugins():
    """List available plugins"""

    async def run_plugin_list():
        try:
            config = NeoOSINTConfig()
            from .plugins.manager import PluginManager
            manager = PluginManager(config)
            await manager.load_plugins()
            plugins = manager.get_plugin_info()
            if plugins:
                click.echo('üîå Available plugins:')
                for plugin in plugins:
                    click.echo(f"   ‚Ä¢ {plugin['name']} v{plugin['version']}")
                    click.echo(f"     {plugin['description']}")
            else:
                click.echo('‚ÑπÔ∏è  No plugins loaded')
            await manager.cleanup()
        except Exception as e:
            click.echo(f'‚ùå Failed to list plugins: {str(e)}', err=True)
            sys.exit(1)
    asyncio.run(run_plugin_list())
if __name__ == '__main__':
    neo_osint()