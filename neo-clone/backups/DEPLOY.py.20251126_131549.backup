from functools import lru_cache
'\nDEPLOY - Neo-Clone Monitoring System Deployment Script\n\nThis script deploys the monitoring system for immediate production use.\nRun this script to deploy monitoring to your Neo-Clone + OpenCode TUI system.\n'
import os
import sys
import json
import time
import shutil
import subprocess
from pathlib import Path
from typing import Dict, Any, Optional

def print_banner():
    """Print deployment banner"""
    print('=' * 80)
    print('üöÄ NEO-CLONE MONITORING SYSTEM DEPLOYMENT')
    print('=' * 80)
    print('Deploying comprehensive monitoring for Neo-Clone + OpenCode TUI')
    print()

def check_prerequisites():
    """Check deployment prerequisites"""
    print('üîç Checking prerequisites...')
    if sys.version_info < (3, 8):
        print('‚ùå Python 3.8+ required')
        return False
    current_dir = Path.cwd()
    if not (current_dir / 'monitoring_integration.py').exists():
        print('‚ùå Run this script from the monitoring directory')
        return False
    print('‚úÖ Prerequisites check passed')
    return True

def create_deployment_structure():
    """Create deployment directory structure"""
    print('üìÅ Creating deployment structure...')
    dirs_to_create = ['logs', 'data/metrics', 'data/traces', 'data/profiles', 'config', 'backups']
    for dir_path in dirs_to_create:
        Path(dir_path).mkdir(parents=True, exist_ok=True)
        print(f'   ‚úÖ Created {dir_path}')
    return True

def install_dependencies():
    """Install required dependencies"""
    print('üì¶ Installing dependencies...')
    core_deps = ['asyncio-throttle>=1.0.2', 'statistics>=1.0.0']
    optional_deps = ['psutil>=5.9.0', 'prometheus-client>=0.17.0']
    for dep in core_deps:
        try:
            subprocess.run([sys.executable, '-m', 'pip', 'install', dep], check=True, capture_output=True)
            print(f'   ‚úÖ Installed {dep}')
        except subprocess.CalledProcessError as e:
            print(f'   ‚ö†Ô∏è  Failed to install {dep}: {e}')
            return False
    for dep in optional_deps:
        try:
            subprocess.run([sys.executable, '-m', 'pip', 'install', dep], check=True, capture_output=True)
            print(f'   ‚úÖ Installed {dep}')
        except subprocess.CalledProcessError:
            print(f'   ‚ö†Ô∏è  Optional dependency {dep} not installed')
    return True

def create_production_config():
    """Create production configuration"""
    print('‚öôÔ∏è  Creating production configuration...')
    config = {'monitoring': {'enabled': True, 'tracing_enabled': True, 'metrics_enabled': True, 'profiling_enabled': True, 'dashboard_enabled': True, 'auto_instrument_brain': True, 'auto_instrument_skills': True, 'opencode_integration': True}, 'performance': {'cpu_threshold': 80.0, 'memory_threshold': 85.0, 'response_time_threshold': 2000.0, 'monitoring_interval': 1.0}, 'tracing': {'service_name': 'neo-clone-opencode', 'sample_rate': 0.1, 'endpoint': None, 'jaeger_endpoint': None, 'otlp_endpoint': None}, 'metrics': {'export_interval': 30.0, 'endpoint': None, 'prometheus_port': 8080, 'retention_hours': 24}, 'profiling': {'sample_rate': 0.05, 'min_duration_ms': 100.0, 'memory_profiling': False, 'cpu_profiling': True}, 'dashboard': {'enabled': True, 'refresh_interval': 2.0, 'port': 8081, 'host': 'localhost'}, 'error_handling': {'max_errors_per_window': 100, 'error_window_minutes': 5, 'circuit_breaker_threshold': 5, 'circuit_breaker_timeout': 60, 'log_dir': 'logs'}, 'logging': {'level': 'INFO', 'file': 'logs/monitoring.log', 'max_size_mb': 100, 'backup_count': 5}}
    config_file = Path('config/monitoring_config.json')
    with open(config_file, 'w') as f:
        json.dump(config, f, indent=2)
    print(f'   ‚úÖ Configuration created: {config_file}')
    return True

def create_startup_script():
    """Create startup script for monitoring"""
    print('üöÄ Creating startup script...')
    startup_script = '#!/usr/bin/env python3\n"""\nNeo-Clone Monitoring System Startup Script\n"""\n\nimport sys\nimport os\nfrom pathlib import Path\n\n# Add monitoring to path\nmonitoring_dir = Path(__file__).parent\nsys.path.insert(0, str(monitoring_dir))\n\ndef start_monitoring():\n    """Start the monitoring system"""\n    try:\n        print("üöÄ Starting Neo-Clone Monitoring System...")\n        \n        # Import and initialize monitoring\n        from monitoring_integration import get_global_monitoring, MonitoringConfig\n        \n        # Load configuration\n        config_file = monitoring_dir / "config" / "monitoring_config.json"\n        if config_file.exists():\n            import json\n            with open(config_file) as f:\n                config_data = json.load(f)\n            config = MonitoringConfig(**config_data.get(\'monitoring\', {}))\n            print("‚úÖ Configuration loaded")\n        else:\n            config = MonitoringConfig()\n            print("‚ö†Ô∏è  Using default configuration")\n        \n        # Initialize monitoring\n        monitoring = get_global_monitoring()\n        if monitoring.initialize():\n            print("‚úÖ Monitoring system initialized successfully")\n            \n            # Start background tasks\n            if hasattr(monitoring, \'start_background_tasks\'):\n                import asyncio\n                asyncio.run(monitoring.start_background_tasks())\n                print("‚úÖ Background tasks started")\n            \n            print("üéØ Monitoring system is running!")\n            print("üìä Dashboard available at: http://localhost:8081")\n            print("üìà Metrics available at: http://localhost:8080/metrics")\n            \n            # Keep running\n            try:\n                import time\n                while True:\n                    time.sleep(60)\n                    # Health check could go here\n            except KeyboardInterrupt:\n                print("\\nüõë Shutting down monitoring system...")\n                monitoring.shutdown()\n                print("‚úÖ Monitoring system stopped")\n        else:\n            print("‚ùå Failed to initialize monitoring system")\n            return False\n            \n    except Exception as e:\n        print(f"‚ùå Error starting monitoring: {e}")\n        import traceback\n        traceback.print_exc()\n        return False\n\nif __name__ == "__main__":\n    start_monitoring()\n'
    startup_file = Path('start_monitoring.py')
    with open(startup_file, 'w') as f:
        f.write(startup_script)
    if os.name != 'nt':
        os.chmod(startup_file, 493)
    print(f'   ‚úÖ Startup script created: {startup_file}')
    return True

def create_integration_wrapper():
    """Create integration wrapper for OpenCode TUI"""
    print('üîó Creating OpenCode TUI integration...')
    integration_code = '\n"""\nOpenCode TUI Integration Wrapper for Neo-Clone Monitoring\n\nThis module provides automatic monitoring integration for OpenCode TUI agents.\n"""\n\nimport sys\nimport os\nfrom pathlib import Path\n\n# Add monitoring to path\nmonitoring_dir = Path(__file__).parent.parent / "monitoring"\nsys.path.insert(0, str(monitoring_dir))\n\ndef wrap_neo_clone_tool(original_neo_clone_func):\n    """Wrap neo-clone tool with monitoring"""\n    def monitored_neo_clone(message: str, mode: str = "tool", timeout: int = 300000):\n        try:\n            from monitoring_integration import get_global_monitoring, MonitoredOperation\n            \n            monitoring = get_global_monitoring()\n            \n            with MonitoredOperation(monitoring, "neo_clone_execution", \n                                  metadata={\'mode\': mode, \'timeout\': timeout}):\n                return original_neo_clone_func(message, mode, timeout)\n                \n        except ImportError:\n            # Fallback to original function if monitoring not available\n            return original_neo_clone_func(message, mode, timeout)\n    \n    return monitored_neo_clone\n\ndef wrap_model_selector_tool(original_model_selector_func):\n    """Wrap model selector tool with monitoring"""\n    def monitored_model_selector(task: str, requirements: dict, \n                                   max_recommendations: int = 3, format: str = "simple"):\n        try:\n            from monitoring_integration import get_global_monitoring, MonitoredOperation\n            \n            monitoring = get_global_monitoring()\n            \n            with MonitoredOperation(monitoring, "model_selection",\n                                  metadata={\'task\': task, \'format\': format}):\n                return original_model_selector_func(task, requirements, \n                                               max_recommendations, format)\n                                               \n        except ImportError:\n            # Fallback to original function if monitoring not available\n            return original_model_selector_func(task, requirements, \n                                           max_recommendations, format)\n    \n    return monitored_model_selector\n\n# Auto-apply monitoring if environment variable is set\nif os.getenv(\'NEO_CLONE_MONITORING_ENABLED\', \'true\').lower() == \'true\':\n    try:\n        # Import original tools (these would be the actual tool functions)\n        # This is a template - actual imports would depend on your setup\n        \n        print("‚úÖ Neo-Clone monitoring integration enabled")\n        \n    except ImportError as e:\n        print(f"‚ö†Ô∏è  Could not enable monitoring integration: {e}")\n'
    integration_file = Path('opencode_integration.py')
    with open(integration_file, 'w') as f:
        f.write(integration_code)
    print(f'   ‚úÖ Integration wrapper created: {integration_file}')
    return True

def create_health_check():
    """Create health check script"""
    print('üè• Creating health check script...')
    health_check_script = '#!/usr/bin/env python3\n"""\nNeo-Clone Monitoring System Health Check\n"""\n\nimport sys\nimport json\nimport time\nfrom pathlib import Path\n\n# Add monitoring to path\nmonitoring_dir = Path(__file__).parent\nsys.path.insert(0, str(monitoring_dir))\n\ndef check_health():\n    """Check monitoring system health"""\n    try:\n        from monitoring_integration import get_global_monitoring\n        from error_handling import get_global_error_handler\n        \n        monitoring = get_global_monitoring()\n        error_handler = get_global_error_handler()\n        \n        health_status = {\n            "timestamp": time.time(),\n            "status": "healthy",\n            "checks": {}\n        }\n        \n        # Check monitoring initialization\n        health_status["checks"]["monitoring_initialized"] = monitoring.status.initialized\n        if not monitoring.status.initialized:\n            health_status["status"] = "unhealthy"\n        \n        # Check error rates\n        error_summary = error_handler.get_error_summary(hours=1)\n        health_status["checks"]["error_count"] = error_summary["total_errors"]\n        if error_summary["total_errors"] > 10:\n            health_status["status"] = "degraded"\n        \n        # Check active operations\n        health_status["checks"]["active_operations"] = len(monitoring.active_operations)\n        \n        # Print health status\n        print(json.dumps(health_status, indent=2))\n        \n        return health_status["status"] in ["healthy", "degraded"]\n        \n    except Exception as e:\n        error_status = {\n            "timestamp": time.time(),\n            "status": "unhealthy",\n            "error": str(e)\n        }\n        print(json.dumps(error_status, indent=2))\n        return False\n\nif __name__ == "__main__":\n    success = check_health()\n    sys.exit(0 if success else 1)\n'
    health_file = Path('health_check.py')
    with open(health_file, 'w') as f:
        f.write(health_check_script)
    if os.name != 'nt':
        os.chmod(health_file, 493)
    print(f'   ‚úÖ Health check script created: {health_file}')
    return True

def create_systemd_service():
    """Create systemd service file for Linux"""
    if os.name != 'nt':
        print('üîß Creating systemd service...')
        service_content = '[Unit]\nDescription=Neo-Clone Monitoring System\nAfter=network.target\n\n[Service]\nType=simple\nUser=neo-clone\nWorkingDirectory={monitoring_dir}\nExecStart={python_path} {startup_script}\nRestart=always\nRestartSec=10\nEnvironment=NEO_CLONE_MONITORING_ENABLED=true\n\n[Install]\nWantedBy=multi-user.target\n'.format(monitoring_dir=str(Path.cwd()), python_path=sys.executable, startup_script=str(Path.cwd() / 'start_monitoring.py'))
        service_file = Path('neo-clone-monitoring.service')
        with open(service_file, 'w') as f:
            f.write(service_content)
        print(f'   ‚úÖ Systemd service created: {service_file}')
        print('   üí° To install: sudo cp neo-clone-monitoring.service /etc/systemd/system/')
        print('   üí° To enable: sudo systemctl enable neo-clone-monitoring')
        print('   üí° To start: sudo systemctl start neo-clone-monitoring')
    return True

def test_deployment():
    """Test the deployment"""
    print('üß™ Testing deployment...')
    try:
        sys.path.insert(0, str(Path.cwd()))
        from monitoring_integration import get_global_monitoring
        monitoring = get_global_monitoring()
        success = monitoring.initialize()
        if success:
            print('   ‚úÖ Monitoring system initialized successfully')
            operation_id = monitoring.start_operation('test_deployment')
            result = monitoring.end_operation(operation_id, True)
            if result.get('success', True):
                print('   ‚úÖ Basic operation test passed')
            else:
                print('   ‚ö†Ô∏è  Basic operation test failed')
            return True
        else:
            print('   ‚ùå Monitoring system initialization failed')
            return False
    except Exception as e:
        print(f'   ‚ùå Deployment test failed: {e}')
        return False

def create_deployment_summary():
    """Create deployment summary"""
    print('üìã Creating deployment summary...')
    summary = {'deployment_timestamp': time.time(), 'deployment_version': '1.0.0', 'components': {'monitoring_integration': '‚úÖ Deployed', 'distributed_tracing': '‚úÖ Deployed', 'metrics_collection': '‚úÖ Deployed', 'performance_profiler': '‚úÖ Deployed', 'error_handling': '‚úÖ Deployed', 'tui_dashboard': '‚úÖ Deployed'}, 'endpoints': {'dashboard': 'http://localhost:8081', 'metrics': 'http://localhost:8080/metrics', 'health_check': './health_check.py'}, 'commands': {'start': './start_monitoring.py', 'stop': 'Ctrl+C', 'health': './health_check.py', 'status': './health_check.py | jq .status'}, 'configuration': {'file': 'config/monitoring_config.json', 'environment_variable': 'NEO_CLONE_MONITORING_ENABLED=true'}, 'integration': {'opencode_tui': 'opencode_integration.py', 'auto_instrument': True}}
    summary_file = Path('deployment_summary.json')
    with open(summary_file, 'w') as f:
        json.dump(summary, f, indent=2)
    print(f'   ‚úÖ Deployment summary created: {summary_file}')
    return summary

@lru_cache(maxsize=128)
def main():
    """Main deployment function"""
    print_banner()
    if not check_prerequisites():
        sys.exit(1)
    steps = [('Creating directory structure', create_deployment_structure), ('Installing dependencies', install_dependencies), ('Creating configuration', create_production_config), ('Creating startup script', create_startup_script), ('Creating integration wrapper', create_integration_wrapper), ('Creating health check', create_health_check), ('Creating systemd service', create_systemd_service), ('Testing deployment', test_deployment)]
    failed_steps = []
    for (step_name, step_func) in steps:
        print(f'\\n{step_name}...')
        try:
            if not step_func():
                failed_steps.append(step_name)
        except Exception as e:
            print(f'   ‚ùå {step_name} failed: {e}')
            failed_steps.append(step_name)
    summary = create_deployment_summary()
    print('\\n' + '=' * 80)
    if not failed_steps:
        print('üéâ DEPLOYMENT SUCCESSFUL!')
        print('\\nüöÄ Neo-Clone Monitoring System is ready to use!')
        print('\\nüìã Quick Start:')
        print('   1. Start monitoring: ./start_monitoring.py')
        print('   2. View dashboard: http://localhost:8081')
        print('   3. Check health: ./health_check.py')
        print('   4. View metrics: http://localhost:8080/metrics')
        print('\\nüîó Integration:')
        print('   ‚Ä¢ Add to OpenCode TUI: import opencode_integration')
        print('   ‚Ä¢ Auto-monitoring enabled by default')
        print('   ‚Ä¢ Configure: edit config/monitoring_config.json')
        print('\\nüìä Monitoring Features:')
        print('   ‚úÖ Distributed tracing')
        print('   ‚úÖ Performance metrics')
        print('   ‚úÖ Real-time profiling')
        print('   ‚úÖ Error handling')
        print('   ‚úÖ TUI dashboard')
        print('   ‚úÖ Health monitoring')
    else:
        print('‚ùå DEPLOYMENT FAILED!')
        print(f"\\nFailed steps: {', '.join(failed_steps)}")
        print('\\nüîß Troubleshooting:')
        print('   1. Check Python version (3.8+ required)')
        print('   2. Check internet connection for dependencies')
        print('   3. Check file permissions')
        print('   4. Review error messages above')
    print('=' * 80)
    return len(failed_steps) == 0
if __name__ == '__main__':
    success = main()
    sys.exit(0 if success else 1)