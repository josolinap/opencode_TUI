from functools import lru_cache
'\nQuick Fix: Improved Site Recognition for Neo-Clone\n'
ENHANCED_SITE_PATTERNS = {'search_engine': {'primary_indicators': ['google.com', 'bing.com', 'duckduckgo.com', 'yahoo.com/search', 'search', 'input[name="q"]', 'textarea[name="q"]', '.gLFyf', 'input[title*="search"]', '[aria-label*="search"]'], 'secondary_indicators': ['search button', 'magnifying glass', 'search results', 'input[type="search"]', '.search', '#search'], 'confidence_threshold': 0.6}, 'ecommerce': {'primary_indicators': ['amazon.com', 'ebay.com', 'shopify.com', 'walmart.com', 'cart', 'checkout', 'add to cart', 'buy now', 'price', 'product', 'shipping', 'payment', 'order'], 'secondary_indicators': ['reviews', 'wishlist', 'compare', 'categories', 'sale', 'discount', 'customer reviews'], 'confidence_threshold': 0.7}, 'social_media': {'primary_indicators': ['facebook.com', 'twitter.com', 'instagram.com', 'linkedin.com', 'login', 'signup', 'post', 'share', 'like', 'comment', 'profile', 'timeline', 'news feed'], 'secondary_indicators': ['followers', 'following', 'friends', 'messages', 'notifications', 'settings', 'logout'], 'confidence_threshold': 0.7}, 'corporate': {'primary_indicators': ['about us', 'contact', 'services', 'products', 'company', 'team', 'careers', 'investors', 'support', 'help', 'documentation'], 'secondary_indicators': ['privacy policy', 'terms of service', 'sitemap', 'newsletter', 'blog', 'press release'], 'confidence_threshold': 0.6}, 'news_media': {'primary_indicators': ['news', 'article', 'breaking', 'headlines', 'journalist', 'editor', 'publication', 'media'], 'secondary_indicators': ['category', 'trending', 'popular', 'latest', 'opinion', 'analysis', 'investigation'], 'confidence_threshold': 0.6}}
ROBUST_SELECTORS = {'search_input': ['textarea[name="q"]', 'input[name="q"]', 'input[type="search"]', 'input[title*="Search"]', '[aria-label*="search"]', '.search-input', '#search', '.gLFyf', '#twotabsearchtextbox'], 'login_email': ['input[type="email"]', 'input[name="email"]', 'input[name="username"]', 'input[id*="email"]', 'input[placeholder*="email"]', '.email-input', '#email'], 'login_password': ['input[type="password"]', 'input[name="password"]', 'input[id*="password"]', '.password-input', '#password'], 'submit_button': ['button[type="submit"]', 'input[type="submit"]', 'button:contains("Submit")', 'button:contains("Login")', 'button:contains("Sign In")', '.submit-btn', '#submit']}

async def smart_retry(page, action_func, max_attempts=3, delay=1):
    """Execute action with intelligent retry."""
    for attempt in range(max_attempts):
        try:
            return await action_func()
        except Exception as e:
            if attempt == max_attempts - 1:
                print(f'Action failed after {max_attempts} attempts: {e}')
                raise e
            wait_time = delay * 2 ** attempt
            print(f'Attempt {attempt + 1} failed, retrying in {wait_time}s...')
            await page.wait_for_timeout(wait_time * 1000)

@lru_cache(maxsize=128)
def analyze_site_enhanced(content, url):
    """Improved site analysis with better pattern matching."""
    content_lower = content.lower()
    url_lower = url.lower()
    scores = {}
    for (site_type, patterns) in ENHANCED_SITE_PATTERNS.items():
        score = 0
        for indicator in patterns['primary_indicators']:
            if indicator in content_lower or indicator in url_lower:
                score += 2
        for indicator in patterns['secondary_indicators']:
            if indicator in content_lower:
                score += 1
        max_possible = len(patterns['primary_indicators']) * 2 + len(patterns['secondary_indicators'])
        normalized_score = score / max_possible if max_possible > 0 else 0
        scores[site_type] = {'score': normalized_score, 'confidence': normalized_score, 'meets_threshold': normalized_score >= patterns['confidence_threshold']}
    best_type = max(scores.keys(), key=lambda k: scores[k]['score'])
    best_score = scores[best_type]
    return {'site_type': best_type if best_score['meets_threshold'] else 'unknown', 'confidence': best_score['confidence'], 'all_scores': scores, 'url': url}
print('Enhanced site recognition patterns loaded!')
print("This improves Neo-Clone's site type detection accuracy.")