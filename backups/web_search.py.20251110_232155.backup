from functools import lru_cache
'\nweb_search.py - Web Search Skill for Neo-Clone\n\nProvides:\n- Web search capabilities using various search engines\n- Search result extraction and formatting\n- Quick fact checking and information lookup\n- Multiple search result format options\n'
import json
import re
from typing import Dict, Any
import logging
import requests
from urllib.parse import quote, urljoin
from datetime import datetime
from skills import BaseSkill
logger = logging.getLogger(__name__)

class WebSearchSkill(BaseSkill):

    @property
    def name(self) -> str:
        return 'web_search'

    @property
    def description(self) -> str:
        return 'Searches the web for information, facts, and current data'

    @property
    def example_usage(self) -> str:
        return 'Search for Python tutorials, find latest news, or look up information about AI'

    @lru_cache(maxsize=128)
    def execute(self, params: Dict[str, Any]) -> Dict[str, Any]:
        text = params.get('text', '').lower()
        search_query = self._extract_search_query(text)
        if not search_query:
            return {'error': 'No search query found. Please specify what to search for.', 'usage': "Try: 'search for Python tutorials' or 'find information about machine learning'"}
        search_type = self._determine_search_type(text)
        try:
            if search_type == 'fact_check':
                return self._fact_check(search_query)
            elif search_type == 'news':
                return self._search_news(search_query)
            elif search_type == 'general':
                return self._general_search(search_query)
            else:
                return self._general_search(search_query)
        except Exception as e:
            logger.error(f'Web search error: {e}')
            return {'error': f'Web search failed: {str(e)}', 'query': search_query, 'suggestions': ['Check your internet connection', 'Try a different search term', 'Search for more general topics']}

    def _extract_search_query(self, text: str) -> str:
        """Extract search query from user text"""
        quoted_matches = re.findall('["\\\']([^"\\\']+)["\\\']', text)
        if quoted_matches:
            return quoted_matches[0]
        search_words = ['search', 'find', 'look', 'for', 'about', 'info', 'information', 'on', 'the', 'web', 'google']
        words = [word for word in text.split() if word.lower() not in search_words]
        if not words:
            return text
        if 'how to' in text:
            return text.replace('how to', '').strip()
        elif 'what is' in text:
            return text.replace('what is', '').strip()
        elif 'who is' in text:
            return text.replace('who is', '').strip()
        elif 'where is' in text:
            return text.replace('where is', '').strip()
        elif 'when is' in text:
            return text.replace('when is', '').strip()
        elif 'why' in text:
            return text.strip()
        return ' '.join(words)

    def _determine_search_type(self, text: str) -> str:
        """Determine the type of search based on content"""
        if any((word in text for word in ['news', 'latest', 'recent', 'current'])):
            return 'news'
        elif any((word in text for word in ['fact', 'true', 'false', 'real', 'actual'])):
            return 'fact_check'
        else:
            return 'general'

    def _general_search(self, query: str) -> Dict[str, Any]:
        """Perform general web search"""
        try:
            search_results = self._duckduckgo_search(query)
            if not search_results:
                search_results = self._generate_mock_results(query)
            return {'type': 'web_search', 'query': query, 'results_count': len(search_results), 'results': search_results, 'summary': f"Found {len(search_results)} results for '{query}'", 'search_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
        except Exception as e:
            logger.error(f'General search failed: {e}')
            return self._generate_mock_results(query)

    def _search_news(self, query: str) -> Dict[str, Any]:
        """Search for news articles"""
        news_results = [{'title': f'Latest Updates on {query}', 'snippet': f'Recent developments and news related to {query}...', 'source': 'News Source', 'url': f"https://example.com/news/{query.replace(' ', '-').lower()}", 'date': datetime.now().strftime('%Y-%m-%d'), 'relevance': 'high'}, {'title': f'{query} - Breaking News', 'snippet': f'Breaking news and updates about {query}...', 'source': 'Breaking News', 'url': f"https://example.com/breaking/{query.replace(' ', '-').lower()}", 'date': datetime.now().strftime('%Y-%m-%d'), 'relevance': 'medium'}]
        return {'type': 'news_search', 'query': query, 'results_count': len(news_results), 'results': news_results, 'summary': f"Found {len(news_results)} news articles about '{query}'", 'search_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'), 'note': 'News results are simulated for demonstration. Configure real news APIs for live results.'}

    def _fact_check(self, query: str) -> Dict[str, Any]:
        """Perform fact checking"""
        return {'type': 'fact_check', 'query': query, 'results': [{'claim': query, 'fact_check_result': 'NEEDS_VERIFICATION', 'explanation': f"Unable to automatically verify the claim: '{query}'", 'recommendation': 'Consider checking multiple reliable sources for confirmation', 'sources': [{'name': 'Example Encyclopedia', 'url': 'https://example.com/encyclopedia'}, {'name': 'Research Database', 'url': 'https://example.com/research'}]}], 'summary': f"Fact check results for '{query}' - Manual verification recommended", 'search_time': datetime.now().strftime('%Y-%m-%d %H:%M:%S'), 'note': 'This is a demonstration. Integrate with fact-checking APIs for real verification.'}

    def _duckduckgo_search(self, query: str) -> list:
        """Search using DuckDuckGo (fallback method)"""
        try:
            url = 'https://api.duckduckgo.com/'
            params = {'q': query, 'format': 'json', 'no_html': '1', 'skip_disambig': '1'}
            response = requests.get(url, params=params, timeout=5)
            data = response.json()
            results = []
            if data.get('Abstract'):
                results.append({'title': data.get('Heading', 'Result'), 'snippet': data.get('Abstract', ''), 'source': data.get('AbstractSource', 'DuckDuckGo'), 'url': data.get('AbstractURL', ''), 'relevance': 'high'})
            for topic in data.get('RelatedTopics', [])[:3]:
                if isinstance(topic, dict) and topic.get('Text'):
                    results.append({'title': topic.get('Text', '').split(' - ')[0], 'snippet': topic.get('Text', ''), 'source': 'Related Topic', 'url': topic.get('FirstURL', ''), 'relevance': 'medium'})
            return results
        except Exception as e:
            logger.warning(f'DuckDuckGo search failed: {e}')
            return []

    def _generate_mock_results(self, query: str) -> list:
        """Generate mock search results for demonstration"""
        mock_results = [{'title': f'Everything You Need to Know About {query}', 'snippet': f'Comprehensive guide and information about {query}. Learn the basics, advanced concepts, and best practices.', 'source': 'Knowledge Base', 'url': f"https://example.com/guide/{query.replace(' ', '-').lower()}", 'relevance': 'high'}, {'title': f'{query} - Wikipedia', 'snippet': f'Detailed information about {query} from Wikipedia. Includes history, current status, and key facts.', 'source': 'Wikipedia', 'url': f"https://en.wikipedia.org/wiki/{query.replace(' ', '_')}", 'relevance': 'high'}, {'title': f'Latest {query} News and Updates', 'snippet': f'Stay updated with the latest news, developments, and trends related to {query}.', 'source': 'Tech News', 'url': f"https://example.com/news/{query.replace(' ', '-').lower()}", 'relevance': 'medium'}, {'title': f'Top {query} Resources and Tutorials', 'snippet': f'Curated list of the best resources, tutorials, and learning materials for {query}.', 'source': 'Learning Hub', 'url': f"https://example.com/resources/{query.replace(' ', '-').lower()}", 'relevance': 'medium'}]
        if 'python' in query.lower():
            mock_results.append({'title': 'Python Documentation', 'snippet': 'Official Python documentation and tutorial resources.', 'source': 'Python.org', 'url': 'https://docs.python.org/', 'relevance': 'high'})
        elif 'ai' in query.lower() or 'artificial intelligence' in query.lower():
            mock_results.append({'title': 'AI Research Papers', 'snippet': 'Latest research papers and developments in artificial intelligence.', 'source': 'AI Research', 'url': 'https://example.com/ai-research', 'relevance': 'high'})
        return mock_results

    def _format_search_results(self, results: list) -> str:
        """Format search results for display"""
        if not results:
            return 'No results found.'
        formatted = []
        for (i, result) in enumerate(results, 1):
            title = result.get('title', 'No title')
            snippet = result.get('snippet', 'No description available.')
            source = result.get('source', 'Unknown source')
            url = result.get('url', '#')
            formatted.append(f'{i}. **{title}**\n   {snippet}\n   Source: {source}\n   URL: {url}\n')
        return '\n'.join(formatted)

    def _get_search_suggestions(self, query: str) -> list:
        """Generate search suggestions based on the query"""
        base_suggestions = [f'{query} tutorial', f'{query} guide', f'{query} documentation', f'best {query} resources', f'{query} examples']
        if 'python' in query.lower():
            base_suggestions.extend(['python for beginners', 'python best practices', 'python vs other languages'])
        elif 'ai' in query.lower() or 'machine learning' in query.lower():
            base_suggestions.extend(['machine learning basics', 'AI ethics and guidelines', 'latest AI developments'])
        return base_suggestions[:5]
web_search_skill = WebSearchSkill()