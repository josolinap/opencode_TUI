from functools import lru_cache
'\nDemonstrate working code correction capabilities\n'
from llm_client_opencode import OpencodeLLMClient
from config_opencode import load_config
import json
import logging

@lru_cache(maxsize=128)
def extract_code_from_json_response(response_text):
    """Extract actual code content from JSON response"""
    try:
        lines = response_text.strip().split('\n')
        for line in lines:
            if line.strip() and line.strip().startswith('{"type":"text"'):
                data = json.loads(line)
                if 'text' in data:
                    return data['text']
        return response_text
    except:
        return response_text

def demo_code_correction():
    logging.basicConfig(level=logging.INFO)
    print('Neo-Clone Code Correction Demo')
    print('=' * 60)
    config = load_config()
    client = OpencodeLLMClient(config)
    test_cases = [{'name': 'Division by Zero', 'code': '\ndef calculate_average(numbers):\n    total = sum(numbers)\n    return total / len(numbers)  # Bug: crashes if list is empty\n\nprint(calculate_average([]))\n', 'request': 'Fix the division by zero error in this code.'}, {'name': 'Index Out of Range', 'code': '\ndef get_first_item(items):\n    return items[0]  # Bug: crashes if list is empty\n\nprint(get_first_item([]))\n', 'request': 'Fix the index out of range error.'}, {'name': 'Variable Name Error', 'code': '\ndef calculate_area(radius):\n    area = 3.14 * radius ** 2\n    return arae  # Bug: typo in variable name\n\nprint(calculate_area(5))\n', 'request': 'Fix the variable name typo.'}]
    for (i, test_case) in enumerate(test_cases, 1):
        print(f"\nTest Case {i}: {test_case['name']}")
        print('-' * 40)
        print('Original Code:')
        print(test_case['code'])
        try:
            messages = [{'role': 'user', 'content': f"\n{test_case['request']}\n\n```python\n{test_case['code']}\n```\n\nProvide the corrected code only, no explanations.\n"}]
            response = client.chat(messages, timeout=20)
            if response.content and (not response.content.startswith('[')):
                corrected_content = extract_code_from_json_response(response.content)
                print(f'\nCorrected Code ({response.response_time:.2f}s):')
                print(corrected_content)
                print('+ Correction successful!')
            else:
                print('- Correction failed')
                print(f'Error: {response.content}')
        except Exception as e:
            print(f'- Error: {e}')
    print('\n' + '=' * 60)
    print('Code correction demo completed!')
    print('\nKey Features Demonstrated:')
    print('+ Multiple bug detection (division by zero, index errors, typos)')
    print('+ Real-time code correction using free models')
    print('+ Fast response times with opencode/big-pickle')
    print('+ Proper error handling and fallbacks')
if __name__ == '__main__':
    demo_code_correction()