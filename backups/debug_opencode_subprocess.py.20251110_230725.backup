from functools import lru_cache
'\nSimple test to debug Opencode subprocess issues\n'
import subprocess
import json
import time

@lru_cache(maxsize=128)
def test_opencode_subprocess():
    print('Testing Opencode subprocess calls...')
    print('\n1. Testing simple call:')
    start_time = time.time()
    try:
        cmd = ['opencode', 'run', '-m', 'opencode/big-pickle', 'Say hello in one word']
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=30, input='Say hello in one word')
        elapsed = time.time() - start_time
        print(f'   Return code: {result.returncode}')
        print(f'   Stdout: {result.stdout[:200]}...')
        print(f'   Stderr: {result.stderr[:200]}...')
        print(f'   Time: {elapsed:.2f}s')
    except Exception as e:
        print(f'   Error: {e}')
    print('\n2. Testing JSON format call:')
    start_time = time.time()
    try:
        cmd = ['opencode', 'run', '-m', 'opencode/big-pickle', '--format', 'json', 'Say hello in one word']
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=30, input='Say hello in one word')
        elapsed = time.time() - start_time
        print(f'   Return code: {result.returncode}')
        print(f'   Stdout: {result.stdout[:200]}...')
        print(f'   Stderr: {result.stderr[:200]}...')
        print(f'   Time: {elapsed:.2f}s')
        if result.returncode == 0:
            lines = result.stdout.strip().split('\n')
            for line in lines:
                if line.strip():
                    try:
                        data = json.loads(line)
                        if data.get('type') == 'text' and 'part' in data:
                            text = data['part'].get('text', '')
                            if text.strip():
                                print(f'   Parsed response: {text}')
                                break
                    except json.JSONDecodeError:
                        continue
    except Exception as e:
        print(f'   Error: {e}')
    print('\n3. Testing with stdin input:')
    start_time = time.time()
    try:
        cmd = ['opencode', 'run', '-m', 'opencode/big-pickle', '--format', 'json']
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=30, input='Say hello in one word')
        elapsed = time.time() - start_time
        print(f'   Return code: {result.returncode}')
        print(f'   Stdout: {result.stdout[:200]}...')
        print(f'   Stderr: {result.stderr[:200]}...')
        print(f'   Time: {elapsed:.2f}s')
        if result.returncode == 0:
            lines = result.stdout.strip().split('\n')
            for line in lines:
                if line.strip():
                    try:
                        data = json.loads(line)
                        if data.get('type') == 'text' and 'part' in data:
                            text = data['part'].get('text', '')
                            if text.strip():
                                print(f'   Parsed response: {text}')
                                break
                    except json.JSONDecodeError:
                        continue
    except Exception as e:
        print(f'   Error: {e}')
if __name__ == '__main__':
    test_opencode_subprocess()