from functools import lru_cache
'\nTest the integrated file manager\n'
import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from integrated_file_manager import IntegratedFileManager

@lru_cache(maxsize=128)
def test_file_manager():
    """Test the integrated file manager"""
    print('Neo-Clone Integrated File Manager Test')
    print('=' * 50)
    fm = IntegratedFileManager('./test_workspace')
    print(f'Workspace: {fm.workspace_path}')
    (success, message) = fm.create_file('test.py', "print('Hello, Neo-Clone!')\n")
    print(f'Create file: {success} - {message}')
    (success, result) = fm.list_directory('.')
    if success:
        print(f'Directory contents ({len(result)} items):')
        for item in result[:5]:
            type_icon = '[DIR]' if item.is_directory else '[FILE]'
            size_info = f' ({item.size} bytes)' if item.is_file else ''
            print(f'  {type_icon} {item.name}{size_info}')
    else:
        print(f'List directory error: {result}')
    (success, message) = fm.open_file('test.py')
    print(f'Open file: {success} - {message}')
    if success:
        print(f'Current file: {fm.editor.current_file}')
        print(f'Syntax language: {fm.editor.get_syntax_language()}')
        print(f'Content preview: {fm.editor.current_content[:50]}...')
    print(f'\nGit repository: {fm.git_manager.is_git_repo}')
    if not fm.git_manager.is_git_repo:
        (success, message) = fm.git_manager.init_repo()
        print(f'Init git: {success} - {message}')
    status = fm.git_manager.get_status()
    if 'error' not in status:
        print(f"Git status: Branch '{status['current_branch']}', Clean: {status['is_clean']}")
        if status['untracked_files']:
            print(f"  Untracked: {status['untracked_files']}")
    search_results = fm.search_files('test', search_content=True)
    print(f"Search results for 'test': {len(search_results)} items")
    for result in search_results[:3]:
        match_info = f" (lines: {result.get('matching_lines', [])})" if result.get('matching_lines') else ''
        print(f"  {result['path']}{match_info}")
    (success, message) = fm.add_bookmark('test_file', 'test.py')
    print(f'Add bookmark: {success} - {message}')
    bookmarks = fm.get_bookmarks()
    print(f'Bookmarks: {bookmarks}')
    stats = fm.get_file_stats()
    print(f'\nWorkspace statistics:')
    print(f"  Files: {stats.get('total_files', 0)}")
    print(f"  Directories: {stats.get('total_directories', 0)}")
    print(f"  Total size: {stats.get('total_size_mb', 0)} MB")
    print(f"  Git enabled: {stats.get('git_enabled', False)}")
    history = fm.get_operation_history(5)
    print(f'\nRecent operations:')
    for op in history:
        status = '[OK]' if op['success'] else '[FAIL]'
        print(f"  {status} {op['operation']} {op['file_path']} ({op['time_ago']})")
    try:
        import shutil
        shutil.rmtree('./test_workspace')
        print('\n[SUCCESS] Test workspace cleaned up')
    except Exception as e:
        print(f'\n[WARNING] Cleanup failed: {e}')
if __name__ == '__main__':
    test_file_manager()