from functools import lru_cache
'\nNeo-Clone Superior TUI System\nRevolutionary multi-panel interface for AI assistant interaction\n'
import asyncio
import logging
import time
import json
import os
import sys
from typing import Dict, List, Any, Optional, Callable
from dataclasses import dataclass, asdict
from datetime import datetime
from pathlib import Path
from collections import defaultdict, deque
from rich.console import Console
from rich.layout import Layout
from rich.panel import Panel
from rich.text import Text
from rich.table import Table
from rich.tree import Tree
from rich.progress import Progress, SpinnerColumn, TextColumn
from rich.live import Live
from rich.align import Align
from rich.columns import Columns
from rich.rule import Rule
from rich.markdown import Markdown
from rich.syntax import Syntax
from rich.prompt import Prompt
from rich import box
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

@dataclass
class TUIConfig:
    """Configuration for Neo-Clone TUI"""
    theme: str = 'dark'
    auto_save: bool = True
    max_history: int = 1000
    refresh_rate: float = 0.1
    show_line_numbers: bool = True
    word_wrap: bool = True
    enable_animations: bool = True

@dataclass
class ChatMessage:
    """Chat message structure"""
    timestamp: datetime
    sender: str
    content: str
    skill_used: Optional[str] = None
    metadata: Optional[Dict[str, Any]] = None

class NeoCloneTUI:
    """Main Neo-Clone TUI Application"""

    def __init__(self, config: Optional[TUIConfig]=None):
        self.config = config or TUIConfig()
        self.console = Console()
        self.layout = Layout()
        self.chat_history: List[ChatMessage] = []
        self.current_context: Dict[str, Any] = {}
        self.active_skills: Dict[str, Any] = {}
        self.file_browser_path = Path.cwd()
        self.analytics_data = defaultdict(list)
        self.running = False
        self.current_panel = 'chat'
        self.input_buffer = ''
        self._setup_layout()
        self._load_skills()

    def _setup_layout(self):
        """Setup the multi-panel layout"""
        self.layout.split(Layout(name='header', size=3), Layout(name='main'), Layout(name='footer', size=3))
        self.layout['main'].split_row(Layout(name='left', ratio=2), Layout(name='right', ratio=1))
        self.layout['left'].split_column(Layout(name='chat', ratio=3), Layout(name='context', ratio=1))
        self.layout['right'].split_column(Layout(name='skills', ratio=1), Layout(name='files', ratio=1), Layout(name='analytics', ratio=1))

    def _load_skills(self):
        """Load available Neo-Clone skills"""
        skills_dir = Path('skills')
        if skills_dir.exists():
            for skill_file in skills_dir.glob('*.py'):
                if skill_file.name != '__init__.py':
                    skill_name = skill_file.stem
                    self.active_skills[skill_name] = {'file': str(skill_file), 'loaded': False, 'description': self._get_skill_description(skill_file)}
        logger.info(f'Loaded {len(self.active_skills)} skills')

    def _get_skill_description(self, skill_file: Path) -> str:
        """Extract description from skill file"""
        try:
            with open(skill_file, 'r', encoding='utf-8') as f:
                content = f.read()
                if '"""' in content:
                    start = content.find('"""') + 3
                    end = content.find('"""', start)
                    if end > start:
                        return content[start:end].strip()
        except Exception as e:
            logger.warning(f'Could not read description from {skill_file}: {e}')
        return 'No description available'

    def _render_header(self) -> Panel:
        """Render header panel"""
        header_text = Text('ðŸ¤– Neo-Clone Superior TUI', style='bold blue')
        header_text.append(' | ', style='dim')
        header_text.append(f'Skills: {len(self.active_skills)}', style='green')
        header_text.append(' | ', style='dim')
        header_text.append(f'Theme: {self.config.theme}', style='cyan')
        header_text.append(' | ', style='dim')
        header_text.append(datetime.now().strftime('%H:%M:%S'), style='yellow')
        return Panel(Align.center(header_text), box=box.ROUNDED, style='blue on black')

    def _render_chat(self) -> Panel:
        """Render chat panel"""
        if not self.chat_history:
            chat_content = Text('No messages yet. Start a conversation!', style='dim italic')
        else:
            chat_lines = []
            for msg in self.chat_history[-10:]:
                timestamp = msg.timestamp.strftime('%H:%M')
                sender_style = {'user': 'green', 'assistant': 'blue', 'system': 'yellow'}.get(msg.sender, 'white')
                line = Text()
                line.append(f'[{timestamp}] ', style='dim')
                line.append(f'{msg.sender}: ', style=sender_style + ' bold')
                line.append(msg.content[:100] + '...' if len(msg.content) > 100 else msg.content)
                if msg.skill_used:
                    line.append(f' ({msg.skill_used})', style='cyan')
                chat_lines.append(line)
            chat_content = '\n'.join((str(line) for line in chat_lines))
        return Panel(chat_content, title='ðŸ’¬ Chat', title_align='left', box=box.ROUNDED, border_style='blue')

    def _render_context(self) -> Panel:
        """Render context panel"""
        context_info = []
        context_info.append(f'ðŸ“ CWD: {Path.cwd()}')
        if self.current_context:
            context_info.append('\nðŸ“‹ Active Context:')
            for (key, value) in self.current_context.items():
                context_info.append(f'  â€¢ {key}: {str(value)[:50]}...')
        if self.chat_history:
            last_msg = self.chat_history[-1]
            context_info.append(f"\nâ° Last: {last_msg.sender} at {last_msg.timestamp.strftime('%H:%M:%S')}")
        context_text = '\n'.join(context_info)
        return Panel(context_text, title='ðŸ§  Context', title_align='left', box=box.ROUNDED, border_style='green')

    def _render_skills(self) -> Panel:
        """Render skills panel"""
        if not self.active_skills:
            skills_content = Text('No skills loaded', style='dim')
        else:
            skills_table = Table(show_header=True, header_style='bold blue')
            skills_table.add_column('Skill', style='cyan')
            skills_table.add_column('Status', style='green')
            skills_table.add_column('Description', style='white')
            for (skill_name, skill_info) in list(self.active_skills.items())[:8]:
                status = 'âœ…' if skill_info['loaded'] else 'âšª'
                desc = skill_info['description'][:30] + '...' if len(skill_info['description']) > 30 else skill_info['description']
                skills_table.add_row(skill_name, status, desc)
            skills_content = skills_table
        return Panel(skills_content, title='âš¡ Skills', title_align='left', box=box.ROUNDED, border_style='yellow')

    def _render_files(self) -> Panel:
        """Render file browser panel"""
        try:
            files = list(self.file_browser_path.iterdir())
            files.sort(key=lambda x: (x.is_file(), x.name.lower()))
            file_tree = Tree(f'ðŸ“ {self.file_browser_path.name}')
            for item in files[:15]:
                if item.is_dir():
                    file_tree.add(f'ðŸ“ {item.name}/', style='blue')
                else:
                    size = item.stat().st_size
                    size_str = self._format_size(size)
                    file_tree.add(f'ðŸ“„ {item.name} ({size_str})', style='green')
            if len(files) > 15:
                file_tree.add(f'... and {len(files) - 15} more', style='dim')
        except Exception as e:
            file_tree = Text(f'Error: {e}', style='red')
        return Panel(file_tree, title='ðŸ“‚ Files', title_align='left', box=box.ROUNDED, border_style='cyan')

    def _render_analytics(self) -> Panel:
        """Render analytics panel"""
        analytics_info = []
        analytics_info.append(f'ðŸ’¬ Messages: {len(self.chat_history)}')
        analytics_info.append(f'âš¡ Skills: {len(self.active_skills)}')
        if self.analytics_data['response_times']:
            avg_time = sum(self.analytics_data['response_times']) / len(self.analytics_data['response_times'])
            analytics_info.append(f'â±ï¸ Avg Response: {avg_time:.2f}s')
        analytics_info.append(f'ðŸ§  Memory: ~50MB')
        if hasattr(self, 'start_time'):
            uptime = time.time() - self.start_time
            analytics_info.append(f'â° Uptime: {uptime:.0f}s')
        analytics_text = '\n'.join(analytics_info)
        return Panel(analytics_text, title='ðŸ“Š Analytics', title_align='left', box=box.ROUNDED, border_style='magenta')

    def _render_footer(self) -> Panel:
        """Render footer panel"""
        footer_text = Text()
        footer_text.append('Mode: ', style='dim')
        footer_text.append(self.current_panel.upper(), style='bold green')
        footer_text.append(' | ', style='dim')
        footer_text.append('Commands: ', style='dim')
        footer_text.append('[Q]uit ', style='yellow')
        footer_text.append('[C]hat ', style='cyan')
        footer_text.append('[S]kills ', style='green')
        footer_text.append('[F]iles ', style='blue')
        footer_text.append('[H]elp', style='magenta')
        return Panel(Align.center(footer_text), box=box.ROUNDED, style='dim')

    def _format_size(self, size_bytes: int) -> str:
        """Format file size in human readable format"""
        for unit in ['B', 'KB', 'MB', 'GB']:
            if size_bytes < 1024:
                return f'{size_bytes:.1f}{unit}'
            size_bytes /= 1024
        return f'{size_bytes:.1f}TB'

    def update_layout(self):
        """Update all panel content"""
        self.layout['header'].update(self._render_header())
        self.layout['chat'].update(self._render_chat())
        self.layout['context'].update(self._render_context())
        self.layout['skills'].update(self._render_skills())
        self.layout['files'].update(self._render_files())
        self.layout['analytics'].update(self._render_analytics())
        self.layout['footer'].update(self._render_footer())

    def add_message(self, sender: str, content: str, skill_used: Optional[str]=None):
        """Add a message to chat history"""
        message = ChatMessage(timestamp=datetime.now(), sender=sender, content=content, skill_used=skill_used)
        self.chat_history.append(message)
        if len(self.chat_history) > self.config.max_history:
            self.chat_history = self.chat_history[-self.config.max_history:]

    @lru_cache(maxsize=128)
    def handle_input(self, user_input: str) -> Optional[str]:
        """Handle user input and return response"""
        if not user_input.strip():
            return None
        self.add_message('user', user_input)
        if user_input.lower().startswith('/help'):
            response = 'Available commands: /help, /skills, /clear, /theme <dark|light>'
        elif user_input.lower().startswith('/skills'):
            skills_list = '\n'.join((f'â€¢ {name}' for name in self.active_skills.keys()))
            response = f'Available skills:\n{skills_list}'
        elif user_input.lower().startswith('/clear'):
            self.chat_history.clear()
            response = 'Chat history cleared.'
        elif user_input.lower().startswith('/theme'):
            theme = user_input.split()[-1] if len(user_input.split()) > 1 else 'dark'
            self.config.theme = theme
            response = f'Theme changed to {theme}'
        else:
            response = f"I understand you said: '{user_input}'. This is a demo response."
        self.add_message('assistant', response)
        self.analytics_data['response_times'].append(0.5)
        return response

    async def run(self):
        """Main TUI loop"""
        self.running = True
        self.start_time = time.time()
        self.add_message('system', 'Welcome to Neo-Clone Superior TUI! Type /help for commands.')
        try:
            with Live(self.layout, refresh_per_second=10, screen=True) as live:
                while self.running:
                    self.update_layout()
                    await asyncio.sleep(0.1)
                    if len(self.chat_history) == 1 and time.time() - self.start_time > 2:
                        self.add_message('assistant', "I'm ready to help! Try asking me something or use /help to see commands.")
        except KeyboardInterrupt:
            self.console.print('\nðŸ‘‹ Goodbye!', style='bold green')
        finally:
            self.running = False

def main():
    """Main entry point"""
    config = TUIConfig()
    tui = NeoCloneTUI(config)
    try:
        asyncio.run(tui.run())
    except KeyboardInterrupt:
        print('\nðŸ‘‹ Goodbye!')
if __name__ == '__main__':
    main()